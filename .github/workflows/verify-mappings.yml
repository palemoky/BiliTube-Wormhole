name: Verify User Mappings

on:
  workflow_dispatch:
    inputs:
      users:
        description: 'JSON array of users to verify'
        required: true
        type: string
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  issues: write

concurrency:
  group: verify-mappings-${{ github.event_name == 'issues' && github.event.issue.number || 'dispatch' }}
  cancel-in-progress: false

jobs:
  verify:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'user-mapping'))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Parse input
        id: parse
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "users=${{ inputs.users }}" >> $GITHUB_OUTPUT
          else
            # Parse from issue body
            BODY=$(cat <<'EOF'
          ${{ github.event.issue.body }}
          EOF
          )
            # Extract Bilibili UID and YouTube Channel ID from issue
            BILI_UID=$(echo "$BODY" | grep -oP 'Bilibili UID:\s*\K\d+' || echo "")
            YT_ID=$(echo "$BODY" | grep -oP 'YouTube Channel ID:\s*\KUC[\w-]+' || echo "")
            
            if [ -n "$BILI_UID" ] && [ -n "$YT_ID" ]; then
              echo "users=[{\"uid\":\"$BILI_UID\",\"ytChannelId\":\"$YT_ID\",\"issueNumber\":${{ github.event.issue.number }}}]" >> $GITHUB_OUTPUT
            else
              echo "users=[]" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Run verification
        id: verify
        env:
          # Optional: Only needed for WBI-authenticated endpoints or to avoid rate limits
          BILIBILI_SESSDATA: ${{ secrets.BILIBILI_SESSDATA }}
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          USERS_JSON: ${{ steps.parse.outputs.users }}
        run: |
          cat > verify-input.json <<EOF
          $USERS_JSON
          EOF
          bun run workflow:verify

      - name: Commit mapping updates
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/
          git diff --staged --quiet || git commit -m "chore: update user mappings [skip ci]"
          git push

      - name: Update issue (if from issue)
        if: github.event_name == 'issues' && success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('verify-results.json', 'utf8'));

            for (const result of results) {
              if (result.issueNumber) {
                const labels = result.success ? ['verified'] : ['manual-review'];
                
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: result.issueNumber,
                  labels: labels
                });
                
                const comment = result.success
                  ? `✅ Verification successful!\n\n**Confidence Level**: ${result.level}\n**Confidence Score**: ${(result.confidence * 100).toFixed(1)}%\n\n**Reasons**:\n${result.reasons.map(r => `- ${r}`).join('\n')}`
                  : `⚠️ Automatic verification failed. Manual review required.\n\n**Reasons**:\n${result.reasons.map(r => `- ${r}`).join('\n')}`;
                
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: result.issueNumber,
                  body: comment
                });
                
                if (result.success) {
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: result.issueNumber,
                    state: 'closed'
                  });
                }
              }
            }
